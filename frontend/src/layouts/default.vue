<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { RouterLink } from 'vue-router'
import UserForm from '@/components/UserForm.vue'
import { useSocket } from '@/composables/useSocket'
import { Github, UserRound } from 'lucide-vue-next'
import { UserRoundCog } from 'lucide-vue-next'
import { UserRoundPlus } from 'lucide-vue-next'

const formIsActive = ref<boolean>(false)
const roomIdRef = ref<string>('')
const { allOnlineUsers, chattingUsers, searchingUsers } = useSocket(roomIdRef)
const isMyDataAvailable = ref<boolean>(false)

onMounted(() => {
  const stored = localStorage.getItem('userSearchFilters')
  if (stored) {
    const parsed = JSON.parse(stored)
    if (parsed.age && parsed.gender) {
      isMyDataAvailable.value = true
    }
  }
})
</script>

<template>
  <div class="layout min-h-screen flex flex-col">
    <header class="border-b border-gray-200 backdrop-blur-[0.0938rem] absolute top-0 left-0 w-full">
      <div class="container mx-auto px-4 py-4 flex items-center justify-between">
        <RouterLink to="/" class="text-2xl font-semibold w-40 text-gray-800">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink"
            version="1.1"
            viewBox="0 0 950 200"
            xml:space="preserve"
          >
            <desc>Created with Fabric.js 5.2.4</desc>
            <defs></defs>
            <g transform="matrix(1 0 0 1 475 100)" id="46f6e94b-76a7-42fa-a578-7310046e72d8">
              <rect
                style="
                  stroke: none;
                  stroke-width: 1;
                  stroke-dasharray: none;
                  stroke-linecap: butt;
                  stroke-dashoffset: 0;
                  stroke-linejoin: miter;
                  stroke-miterlimit: 4;
                  fill: rgb(255, 255, 255);
                  fill-rule: nonzero;
                  opacity: 1;
                  visibility: hidden;
                "
                vector-effect="non-scaling-stroke"
                x="-475"
                y="-100"
                rx="0"
                ry="0"
                width="950"
                height="200"
              />
            </g>
            <g
              transform="matrix(Infinity NaN NaN Infinity 0 0)"
              id="42c708b4-c4ef-4228-9b14-f8384700d8e3"
            ></g>
            <g transform="matrix(1.73 0 0 1.73 475 100)">
              <g style="" vector-effect="non-scaling-stroke">
                <g transform="matrix(1.31 0 0 1.31 -203.74 0)">
                  <rect
                    style="
                      stroke: none;
                      stroke-width: 1;
                      stroke-dasharray: none;
                      stroke-linecap: butt;
                      stroke-dashoffset: 0;
                      stroke-linejoin: miter;
                      stroke-miterlimit: 4;
                      fill: rgb(0, 0, 0);
                      fill-rule: nonzero;
                      opacity: 1;
                    "
                    vector-effect="non-scaling-stroke"
                    x="-49"
                    y="-41"
                    rx="10"
                    ry="10"
                    width="98"
                    height="82"
                  />
                </g>
                <g transform="matrix(4.24 0 0 4.24 -227.06 0.08)">
                  <path
                    style="
                      stroke: none;
                      stroke-width: 1;
                      stroke-dasharray: none;
                      stroke-linecap: butt;
                      stroke-dashoffset: 0;
                      stroke-linejoin: miter;
                      stroke-miterlimit: 4;
                      fill: rgb(255, 255, 255);
                      fill-rule: nonzero;
                      opacity: 1;
                    "
                    vector-effect="non-scaling-stroke"
                    transform=" translate(-3.44, -6.5)"
                    d="M 3 6.4 C 3.0275430774682617 3.758116578395684 4.444917168393055 1.3261610336453682 6.729999999999998 8.881784197001252e-16 L 6.27 0 L 1.91 0 C 0.8551361278231846 0 -2.220446049250313e-16 0.8551361278231844 -2.220446049250313e-16 1.9099999999999997 L 0 6.27 C -0.021336400159792754 8.035440624665924 0.6602649036304837 9.736899374279004 1.8945630849628374 10.99933505214629 C 3.128861266295191 12.261770730013575 4.814526914203168 12.981543984189138 6.579999999999997 13 L 6.89 13 C 4.476438422177292 11.684659974354705 2.9817282472197895 9.148647852318835 3.0000000000000013 6.4 Z"
                    stroke-linecap="round"
                  />
                </g>
                <g transform="matrix(4.24 0 0 4.24 -192.93 0.08)">
                  <path
                    style="
                      stroke: none;
                      stroke-width: 1;
                      stroke-dasharray: none;
                      stroke-linecap: butt;
                      stroke-dashoffset: 0;
                      stroke-linejoin: miter;
                      stroke-miterlimit: 4;
                      fill: rgb(255, 255, 255);
                      fill-rule: nonzero;
                      opacity: 1;
                    "
                    vector-effect="non-scaling-stroke"
                    transform=" translate(-11.5, -6.5)"
                    d="M 11.42 0 C 7.892362484584885 0.04315635314850097 5.0431563531484995 2.8923624845848845 5 6.419999999999999 C 5.0184560158108615 8.18547308579683 5.738229269986424 9.871138733704807 7.00066494785371 11.105436915037162 C 8.263100625720995 12.339735096369516 9.964559375334073 13.021336400159793 11.729999999999997 13 L 16.09 13 C 17.144863872176813 13 18 12.144863872176815 18 11.09 L 18 6.73 C 18.021336400159793 4.964559375334074 17.339735096369516 3.2631006257209973 16.105436915037163 2.0006649478537106 C 14.871138733704807 0.7382292699864239 13.18547308579683 0.018456015810861537 11.419999999999998 0 Z M 12.5 9 L 8.5 9 C 8.223857625084603 9 8 8.776142374915397 8 8.5 C 8 8.223857625084603 8.223857625084603 8 8.5 8 L 12.5 8 C 12.776142374915397 8 13 8.223857625084603 13 8.5 C 13 8.776142374915397 12.776142374915397 9 12.5 9 Z M 14.5 7 L 8.5 7 C 8.223857625084603 7 8 6.776142374915397 8 6.5 C 8 6.223857625084603 8.223857625084603 6 8.5 6 L 14.5 6 C 14.776142374915397 6 15 6.223857625084603 15 6.5 C 15 6.776142374915397 14.776142374915397 7 14.5 7 Z M 14.5 5 L 8.5 5 C 8.223857625084603 5 8 4.776142374915397 8 4.5 C 8 4.223857625084603 8.223857625084603 4 8.5 4 L 14.5 4 C 14.776142374915397 4 15 4.223857625084603 15 4.5 C 15 4.776142374915397 14.776142374915397 5 14.5 5 Z"
                    stroke-linecap="round"
                  />
                </g>
                <g transform="matrix(4.75 0 0 4.75 77.14 -0.13)">
                  <path
                    style="
                      stroke: none;
                      stroke-width: 1;
                      stroke-dasharray: none;
                      stroke-linecap: butt;
                      stroke-dashoffset: 0;
                      stroke-linejoin: miter;
                      stroke-miterlimit: 4;
                      fill: rgb(0, 0, 0);
                      fill-rule: nonzero;
                      opacity: 1;
                    "
                    vector-effect="non-scaling-stroke"
                    transform=" translate(-40.7, -12.56)"
                    d="M 4.56 10.28 C 5.279999999999999 10.28 5.923299999999999 10.41338 6.489999999999999 10.68004 C 7.056699999999999 10.9467 7.4933 11.33336 7.799999999999999 11.84004 L 6.399999999999999 12.90004 C 5.866659999999999 12.273380000000001 5.219999999999999 11.960040000000001 4.459999999999999 11.960040000000001 C 4.006659999999999 11.960040000000001 3.629999999999999 12.06004 3.329999999999999 12.260040000000002 C 3.0299999999999994 12.460040000000003 2.879999999999999 12.713380000000003 2.879999999999999 13.020040000000002 C 2.879999999999999 13.686700000000002 3.499999999999999 14.140040000000003 4.739999999999999 14.380040000000001 C 5.9533 14.606700000000002 6.809999999999999 14.940040000000002 7.309999999999999 15.380040000000001 C 7.809999999999999 15.82004 8.059999999999999 16.446740000000002 8.059999999999999 17.26004 C 8.059999999999999 18.18004 7.709999999999999 18.90334 7.009999999999999 19.430039999999998 C 6.309999999999999 19.956739999999996 5.373299999999999 20.226699999999997 4.199999999999999 20.240039999999997 C 3.3199999999999994 20.240039999999997 2.5966999999999993 20.103379999999998 2.0299999999999994 19.830039999999997 C 1.4632999999999994 19.556699999999996 0.9732999999999994 19.133359999999996 0.5599999999999994 18.560039999999997 L 1.9199999999999995 17.440039999999996 C 2.6399999999999997 18.186699999999995 3.4066999999999994 18.560039999999997 4.219999999999999 18.560039999999997 C 4.753339999999999 18.560039999999997 5.206679999999999 18.453379999999996 5.579999999999999 18.240039999999997 C 5.95332 18.026699999999998 6.139999999999999 17.733359999999998 6.139999999999999 17.36002 C 6.139999999999999 16.70668 5.539999999999999 16.25332 4.339999999999999 16.00002 C 3.006699999999999 15.73336 2.109999999999999 15.3767 1.649999999999999 14.930019999999999 C 1.189999999999999 14.483339999999998 0.9599999999999991 13.906719999999998 0.9599999999999991 13.200019999999999 C 0.9599999999999991 12.320019999999998 1.2999999999999992 11.616719999999999 1.979999999999999 11.090019999999999 C 2.6599999999999993 10.56332 3.519999999999999 10.29336 4.559999999999999 10.280019999999999 z M 11.280000000000001 5.800000000000001 C 11.64 5.800000000000001 11.95002 5.930020000000001 12.210020000000002 6.1900200000000005 C 12.470020000000003 6.45002 12.60002000000002 6.760020000000001 12.60002000000002 7.12002 C 12.60002000000002 7.49336 12.46668000000002 7.8067 12.20002000000002 8.06004 C 11.93336000000002 8.313380000000002 11.626700000000001 8.440040000000002 11.280040000000001 8.440040000000002 C 10.9067 8.440040000000002 10.59336 8.313380000000002 10.34002 8.06004 C 10.086680000000001 7.806699999999999 9.96002 7.493360000000001 9.96002 7.120020000000001 C 9.96002 6.746680000000001 10.09336 6.433340000000001 10.36002 6.1800000000000015 C 10.62668 5.926660000000002 10.933340000000001 5.800000000000002 11.280000000000001 5.800000000000002 z M 12.18 10.52 L 12.18 20 L 10.379999999999999 20 L 10.379999999999999 10.52 L 12.18 10.52 z M 16.98 4.880000000000001 L 16.98 20 L 15.18 20 L 15.18 4.880000000000001 L 16.98 4.880000000000001 z M 24.18 10.28 C 25.6333 10.28 26.7634 10.73664 27.57 11.649999999999999 C 28.3766 12.563359999999998 28.7867 13.819999999999999 28.8 15.419999999999998 L 28.8 15.919999999999998 L 21.200000000000003 15.919999999999998 C 21.200000000000003 16.69334 21.51 17.3433 22.130000000000003 17.869999999999997 C 22.750000000000004 18.396699999999996 23.506700000000002 18.666659999999997 24.400000000000002 18.679999999999996 C 25.386660000000003 18.679999999999996 26.253300000000003 18.206659999999996 27.000000000000004 17.259999999999998 L 28.360000000000003 18.299999999999997 C 27.346700000000002 19.593299999999996 25.946600000000004 20.24 24.160000000000004 20.24 C 22.706700000000005 20.24 21.536600000000004 19.77666 20.650000000000006 18.849999999999998 C 19.763400000000008 17.923339999999996 19.306700000000006 16.726599999999998 19.280000000000005 15.259999999999998 C 19.280000000000005 13.846699999999998 19.736660000000004 12.669999999999998 20.650000000000006 11.729999999999999 C 21.563340000000007 10.79 22.740000000000006 10.3067 24.180000000000007 10.28 z M 26.880000000000003 14.48 C 26.853340000000003 13.58666 26.6 12.9033 26.12 12.43 C 25.64 11.9567 24.98 11.719999999999999 24.14 11.719999999999999 C 23.580000000000002 11.719999999999999 23.076700000000002 11.856659999999998 22.63 12.129999999999999 C 22.183299999999996 12.40334 21.83334 12.75668 21.58 13.19 C 21.326659999999997 13.62332 21.2 14.053339999999999 21.2 14.48 L 26.88 14.48 z M 35.92 10.28 C 36.9867 10.28 37.8233 10.6 38.43 11.239999999999998 C 39.036699999999996 11.879999999999997 39.34666 12.739999999999998 39.36 13.819999999999999 L 39.36 20 L 37.56 20 L 37.56 14.34 C 37.56 13.60666 37.370000000000005 13.0267 36.99 12.6 C 36.61 12.1733 36.080000000000005 11.959999999999999 35.4 11.959999999999999 C 34.559999999999995 11.959999999999999 33.91 12.239999999999998 33.449999999999996 12.799999999999999 C 32.989999999999995 13.36 32.76 14.106699999999998 32.76 15.04 L 32.76 20 L 30.959999999999997 20 L 30.959999999999997 10.52 L 32.76 10.52 L 32.76 11.98 L 32.8 11.98 C 33.05334 11.44666 33.463339999999995 11.030000000000001 34.029999999999994 10.73 C 34.59665999999999 10.43 35.226699999999994 10.280000000000001 35.919999999999995 10.280000000000001 z M 44.58 7.859999999999999 L 44.579980469 10.52 L 47.159980469 10.52 L 47.159980469 12.08 L 44.579980469 12.08 L 44.579980469 16.64 C 44.579980469 17.25334 44.666640469 17.7267 44.839980469 18.060000000000002 C 45.01332046899999 18.393300000000004 45.379980468999996 18.560000000000002 45.939980469 18.560000000000002 C 46.473320469 18.560000000000002 46.899980469 18.46666 47.219980469 18.28 L 47.219980469 19.92 C 46.873320469 20.10666 46.326660469 20.213320000000003 45.579980469 20.239980000000003 C 44.859980469 20.239980000000003 44.303280469 20.129980000000003 43.909980469 19.909980000000004 C 43.51668046899999 19.689980000000006 43.229980469 19.383320000000005 43.049980469 18.989980000000003 C 42.869980469 18.59664 42.779980468999995 17.97998 42.779980468999995 17.13998 L 42.779980468999995 12.079980000000003 L 40.699980468999996 12.079980000000003 L 40.699980468999996 10.519980000000002 L 42.779980468999995 10.519980000000002 L 42.779980468999995 7.859980000000002 L 44.57998046899999 7.859980000000002 z M 51.98 7.859999999999999 L 51.979980469 10.52 L 54.559980468999996 10.52 L 54.559980468999996 12.08 L 51.979980469 12.08 L 51.979980469 16.64 C 51.979980469 17.25334 52.066640469 17.7267 52.239980468999995 18.060000000000002 C 52.41332046899999 18.393300000000004 52.779980468999995 18.560000000000002 53.339980469 18.560000000000002 C 53.873320469 18.560000000000002 54.299980469 18.46666 54.619980469 18.28 L 54.619980469 19.92 C 54.273320469 20.10666 53.726660468999995 20.213320000000003 52.979980469 20.239980000000003 C 52.259980469 20.239980000000003 51.703280469 20.129980000000003 51.309980468999996 19.909980000000004 C 50.91668046899999 19.689980000000006 50.629980468999996 19.383320000000005 50.449980468999996 18.989980000000003 C 50.269980469 18.59664 50.17998046899999 17.97998 50.17998046899999 17.13998 L 50.17998046899999 12.079980000000003 L 48.099980468999995 12.079980000000003 L 48.099980468999995 10.519980000000002 L 50.17998046899999 10.519980000000002 L 50.17998046899999 7.859980000000002 L 51.97998046899999 7.859980000000002 z M 60.67999999999999 10.28 C 61.879999999999995 10.28 62.82999999999999 10.553279999999999 63.529999999999994 11.09994 C 64.22999999999999 11.646600000000001 64.6 12.40664 64.64 13.37994 L 64.64 18.45994 C 64.64 18.93994 64.66666000000001 19.45328 64.72 19.99994 L 63.12 19.99994 C 63.08 19.57328 63.059999999999995 19.09328 63.059999999999995 18.559939999999997 L 63.019999999999996 18.559939999999997 C 62.60666 19.17328 62.129999999999995 19.60664 61.589999999999996 19.859939999999998 C 61.05 20.113239999999998 60.419999999999995 20.239939999999997 59.699999999999996 20.239939999999997 C 58.726659999999995 20.239939999999997 57.936699999999995 19.979939999999996 57.33 19.459939999999996 C 56.7233 18.939939999999996 56.42 18.253239999999995 56.42 17.399939999999997 C 56.42 16.319939999999995 56.87334 15.503239999999998 57.78 14.949939999999998 C 58.68666 14.396639999999998 59.9666 14.119939999999998 61.620000000000005 14.119939999999998 L 62.96000000000001 14.119939999999998 L 62.96000000000001 13.779939999999998 C 62.96000000000001 13.139939999999998 62.75000000000001 12.636639999999998 62.330000000000005 12.269939999999998 C 61.910000000000004 11.903239999999998 61.36000000000001 11.719939999999998 60.68000000000001 11.719939999999998 C 60.17334000000001 11.719939999999998 59.730000000000004 11.796599999999998 59.35000000000001 11.949939999999998 C 58.97000000000001 12.103279999999998 58.52000000000001 12.386619999999999 58.00000000000001 12.799959999999999 L 56.92000000000001 11.679959999999998 C 57.94670000000001 10.773299999999997 59.20000000000001 10.306659999999997 60.68000000000001 10.279959999999997 z M 58.22 17.259999999999998 C 58.22 18.286699999999996 58.90002 18.799999999999997 60.26 18.799999999999997 C 61.073339999999995 18.799999999999997 61.723299999999995 18.556659999999997 62.21 18.069999999999997 C 62.69670000000001 17.583339999999996 62.94666 16.879999999999995 62.96 15.959999999999997 L 62.96 15.439999999999998 L 61.94 15.439999999999998 C 60.7667 15.439999999999998 59.8534 15.589999999999998 59.199999999999996 15.889999999999997 C 58.54659999999999 16.189999999999998 58.22 16.646659999999997 58.22 17.259999999999998 z M 69.19999999999999 4.880000000000001 L 69.19999999999999 20 L 67.39999999999999 20 L 67.39999999999999 4.880000000000001 L 69.19999999999999 4.880000000000001 z M 73.87999999999998 4.880000000000001 L 73.87999999999998 14.64 L 77.97999999999998 10.52 L 80.47999999999998 10.52 L 76.03999999999998 14.84 L 80.83999999999997 20 L 78.27999999999997 20 L 73.87999999999997 15.08 L 73.87999999999997 20 L 72.07999999999997 20 L 72.07999999999997 4.880000000000001 L 73.87999999999997 4.880000000000001 z"
                    stroke-linecap="round"
                  />
                </g>
              </g>
            </g>
          </svg>
        </RouterLink>
        <nav class="flex gap-3 items-center">
          <div class="relative">
            <Transition name="fade">
              <UserForm v-if="formIsActive" @submit="formIsActive = false" />
            </Transition>
            <button
              @click="formIsActive = !formIsActive"
              class="p-2 my-2 rounded-md text-sm font-medium bg-gray-200/60 hover:bg-gray-200 transition"
              :class="{
                'bg-gray-200': formIsActive,
                'bg-gray-100': !formIsActive,
              }"
            >
              <Transition name="fade" mode="out-in">
                <UserRoundPlus v-if="!isMyDataAvailable" />
                <UserRoundCog v-else-if="formIsActive" />
                <UserRound v-else />
              </Transition>
            </button>
          </div>

          <RouterLink
            to="/find"
            class="px-4 py-2 rounded-md text-sm font-medium bg-blue-600 text-white hover:bg-blue-700 transition"
          >
            Начать
          </RouterLink>
        </nav>
      </div>
    </header>

    <main class="flex-1">
      <slot class="pt-[3.5625rem]"></slot>
    </main>
    <footer class="border-t border-gray-200 py-4 text-center text-sm text-gray-500">
      <div class="container">
        <div class="flex items-start gap-8 flex-wrap pt-2 justify-between w-full">
          <div class="flex flex-col items-start gap-3">
            <p>© {{ new Date().getFullYear() }} SilentTalk</p>
            <nav class="flex items-center justify-start gap-3">
              <a href="https://github.com/YangBang74" target="_blank">
                <Github />
              </a>
              <a href="https://t.me/itisyang" target="_blank">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 50 50"
                  width="20"
                  height="20"
                  class="color-brand"
                >
                  <path
                    d="M46.137,6.552c-0.75-0.636-1.928-0.727-3.146-0.238l-0.002,0C41.708,6.828,6.728,21.832,5.304,22.445	c-0.259,0.09-2.521,0.934-2.288,2.814c0.208,1.695,2.026,2.397,2.248,2.478l8.893,3.045c0.59,1.964,2.765,9.21,3.246,10.758	c0.3,0.965,0.789,2.233,1.646,2.494c0.752,0.29,1.5,0.025,1.984-0.355l5.437-5.043l8.777,6.845l0.209,0.125	c0.596,0.264,1.167,0.396,1.712,0.396c0.421,0,0.825-0.079,1.211-0.237c1.315-0.54,1.841-1.793,1.896-1.935l6.556-34.077	C47.231,7.933,46.675,7.007,46.137,6.552z M22,32l-3,8l-3-10l23-17L22,32z"
                    fill="currentColor"
                  />
                </svg>
              </a>
            </nav>
          </div>
          <nav class="flex items-start gap-8">
            <ul class="text-left space-y-2">
              <li>
                <a href="/home">Главная страница</a>
              </li>
              <li><a href="/find">Анонимный чат</a></li>
              <li><a href="/friends">Чат с друзьями</a></li>
            </ul>
            <ul class="text-left space-y-2">
              <li>
                <router-link to="/terms">Правила использования</router-link>
              </li>
              <li>
                <router-link to="/privacy">Политика конфиденциальности</router-link>
              </li>             
            </ul>
          </nav>
          <div class="rounded self-start text-left bg-white">
            <h2 class="text-lg font-bold mb-1">Статистика</h2>
            <p>Онлайн: {{ allOnlineUsers.length }}</p>
            <p>В чатах: {{ chattingUsers.length }}</p>
            <p>В поиске: {{ searchingUsers.length }}</p>
          </div>
        </div>
      </div>
    </footer>
  </div>
</template>
<style scoped>
.fade-enter-active,
.fade-leave-active {
  transition: opacity 0.1s ease;
}

.fade-enter-from,
.fade-leave-to {
  opacity: 0;
}
</style>
